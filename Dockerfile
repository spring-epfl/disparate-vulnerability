FROM python:3.8.1-slim

ENV PYTHONFAULTHANDLER=1 \
  PYTHONUNBUFFERED=1 \
  PYTHONHASHSEED=random \
  PIP_NO_CACHE_DIR=off \
  PIP_DISABLE_PIP_VERSION_CHECK=on \
  PIP_DEFAULT_TIMEOUT=100 \
  POETRY_VERSION=1.1.8

# System deps:
RUN pip install "poetry==$POETRY_VERSION"
RUN apt-get update
RUN apt-get install -y build-essential
RUN apt-get install -y texlive-latex-extra cm-super texlive-science dvipng

# User setup for binder:
ARG NB_USER=jovyan
ARG NB_UID=1000
ENV USER ${NB_USER}
ENV NB_UID ${NB_UID}
ENV HOME /home/${NB_USER}

RUN adduser --disabled-password \
    --gecos "Default user" \
    --uid ${NB_UID} \
    ${USER}
WORKDIR ${HOME}
USER ${USER}
# RUN chown -R ${NB_UID} ${HOME}
COPY --chown=${USER}:${USER} . ${HOME}

# Copy only requirements to cache them in docker layer
COPY poetry.lock pyproject.toml ${HOME}/

# Project initialization:
RUN poetry config virtualenvs.create false && poetry install --no-interaction --no-ansi
ENV PATH="${HOME}/.local/bin:${PATH}"

# Creating folders, and files for a project:
COPY --chown=${USER}:${USER} . ${HOME}
